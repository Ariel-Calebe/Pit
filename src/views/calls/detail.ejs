<% layout('layout') -%>

<section class="max-w-6xl mx-auto p-6">
  <!-- Detalhes do chamado -->
  <header class="text-center mb-6">
    <h2 class="text-2xl font-semibold"><%= call.title %></h2>
    <p class="text-slate-500 mt-1">Jogo: <%= call.gameId %> | Plataforma: <%= call.platform %></p>
  </header>

  <!-- Join Call Button if not participating -->
  <% if (!call.participants.includes(player?.id)) { %>
    <div class="rounded-xl bg-blue-50 border border-blue-200 p-6 text-center">
      <p class="text-blue-800 mb-4">Você ainda não está participando deste chamado. Clique para entrar!</p>
      <form action="/calls/<%= call.id %>/join" method="POST">
        <button type="submit" class="btn btn--primary">Entrar no Chamado</button>
      </form>
    </div>
  <% } %>

  <!-- Main Content Layout -->
  <% if (call.participants.includes(player?.id)) { %>
    <div class="flex flex-col lg:flex-row gap-6 min-h-[600px]">
      <!-- Left Column: Call Details and Participants -->
      <div class="flex-1">
        <!-- Informações do chamado -->
        <div class="rounded-xl bg-white shadow p-6">
          <h3 class="font-medium text-slate-700 mb-4">Participantes</h3>
          <ul class="space-y-3">
            <% participantsData.forEach((participant) => { %>
              <li class="flex items-center justify-between bg-slate-50 p-4 rounded-lg">
                <div class="flex items-center space-x-3">
                  <% if (participant.photoUrl) { %>
                    <img src="<%= participant.photoUrl %>" alt="<%= participant.name %>" class="w-10 h-10 rounded-full">
                  <% } else { %>
                    <div class="w-10 h-10 bg-slate-300 rounded-full flex items-center justify-center">
                      <span class="text-sm text-slate-600"><%= participant.name.charAt(0).toUpperCase() %></span>
                    </div>
                  <% } %>
                  <span class="text-sm font-medium text-slate-700"><%= participant.name %></span>
                </div>
                <div class="flex space-x-2">
                  <% if (participant.uid !== player?.id) { %>
                    <form action="/friends/add" method="POST" class="inline">
                      <input type="hidden" name="friendUid" value="<%= participant.uid %>" />
                      <button type="submit" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        Adicionar Amigo
                      </button>
                    </form>
                  <% } %>
                  <% if (call.ownerUid === player?.id && participant.uid !== player?.id) { %>
                    <form action="/calls/<%= call.id %>/remove/<%= participant.uid %>" method="POST" class="inline">
                      <button type="submit" class="text-red-600 hover:text-red-800 text-sm font-medium">
                        Remover
                      </button>
                    </form>
                  <% } %>
                </div>
              </li>
            <% }) %>
          </ul>

          <!-- Botão para fechar o chamado (somente o dono pode) -->
          <% if (call.ownerUid === player?.id) { %>
            <div class="mt-6">
              <form action="/calls/<%= call.id %>/close" method="POST">
                <button type="submit" class="btn btn--danger">Fechar Chamado</button>
              </form>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Right Column: Call Actions -->
      <div class="flex-1">
        <div class="rounded-xl bg-white shadow p-6">
          <h3 class="font-medium text-slate-700 mb-4">Ações do Chamado</h3>
          <div class="space-y-4">
            <p class="text-slate-600">Você está participando deste chamado. Aguarde outros jogadores ou convide amigos!</p>
            <div class="flex gap-2">
              <button onclick="shareCall()" class="btn btn--secondary">Compartilhar Chamado</button>
              <a href="/calls" class="btn btn--outline">Voltar para Chamados</a>
            </div>
          </div>
        </div>
      </div>
    </div>



  <% } %>
</section>

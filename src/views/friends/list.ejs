<% layout('layout') -%>

<section class="max-w-4xl mx-auto p-6 space-y-6">
  <!-- Header -->
  <header class="text-center">
    <h2 class="text-2xl font-semibold">Amigos</h2>
    <p class="text-slate-500 mt-1">Gerencie suas amizades e solicitações pendentes</p>
  </header>

  <!-- Solicitações Pendentes -->
  <% if (pending && pending.length) { %>
    <div class="rounded-xl bg-yellow-50 border border-yellow-200 p-6">
      <h3 class="text-xl font-semibold text-yellow-800 mb-4">Solicitações Pendentes</h3>
      <div class="space-y-4">
        <% pending.forEach((p) => { %>
          <div class="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm">
            <div class="flex items-center gap-3">
              <img
                src="<%= p.photoUrl || '/default-avatar.png' %>"
                alt="avatar"
                class="h-12 w-12 rounded-full object-cover border"
              />
              <div>
                <p class="font-medium text-slate-800"><%= p.name || 'Jogador' %></p>
                <p class="text-sm text-slate-500"><%= p.email || '' %></p>
              </div>
            </div>
            <div class="flex gap-2">
              <form action="/friends/<%= p.uid %>/accept" method="POST" class="inline">
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                  Aceitar
                </button>
              </form>
              <form action="/friends/<%= p.uid %>/reject" method="POST" class="inline">
                <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                  Rejeitar
                </button>
              </form>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  <% } %>

  <!-- Lista de Amigos -->
  <div class="rounded-xl bg-white shadow p-6">
    <h3 class="text-xl font-semibold text-slate-800 mb-4">Meus Amigos (<%= friends ? friends.length : 0 %>)</h3>
    <% if (friends && friends.length) { %>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <% friends.forEach((f) => { %>
          <div class="flex items-center justify-between bg-slate-50 p-4 rounded-lg">
            <div class="flex items-center gap-3">
              <img
                src="<%= f.photoUrl || '/default-avatar.png' %>"
                alt="avatar"
                class="h-10 w-10 rounded-full object-cover border"
              />
              <div>
                <p class="font-medium text-slate-800"><%= f.name || 'Jogador' %></p>
                <p class="text-sm text-slate-500"><%= f.email || '' %></p>
              </div>
            </div>
            <div class="flex gap-2">
              <button
                onclick="openFriendChat('<%= f.uid %>')"
                class="text-blue-600 hover:text-blue-800 text-sm font-medium"
              >
                Chat
              </button>
              <form action="/friends/<%= f.uid %>/remove" method="POST" class="inline">
                <button type="submit" class="text-red-600 hover:text-red-800 text-sm font-medium">
                  Remover
                </button>
              </form>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <p class="text-slate-500 text-center py-8">Você ainda não tem amigos. Comece adicionando alguém!</p>
    <% } %>
  </div>

  <!-- Friend Chat Modal -->
  <div id="friend-chat-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[80vh] flex flex-col">
        <div class="p-4 border-b">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold" id="friend-chat-title">Chat</h3>
            <button onclick="closeFriendChat()" class="text-slate-400 hover:text-slate-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
        <div id="friend-chat-messages" class="flex-1 p-4 overflow-y-auto max-h-96 bg-slate-50">
          <!-- Messages will be loaded here -->
        </div>
        <form id="friend-message-form" class="p-4 border-t">
          <div class="flex gap-2">
            <input
              type="text"
              id="friend-message-input"
              placeholder="Digite sua mensagem..."
              class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              maxlength="500"
            />
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              Enviar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Pass current user ID to client-side script
    currentUserId = '<%= player?.id %>';
  </script>


  <!-- Voltar para Home -->
  <div class="text-center">
    <a href="/home" class="inline-block bg-slate-900 text-white px-6 py-3 rounded-lg hover:bg-slate-800">
      Voltar para Home
    </a>
  </div>
</section>
